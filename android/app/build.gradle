apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

react { autolinkLibrariesWithApp() }

def enableProguardInReleaseBuilds = false
def jscFlavor = 'io.github.react-native-community:jsc-android:2026004.+'

android {
  ndkVersion rootProject.ext.ndkVersion
  buildToolsVersion rootProject.ext.buildToolsVersion
  compileSdk rootProject.ext.compileSdkVersion

  namespace "com.wizmarket"

  defaultConfig {
    applicationId "com.wizmarket"
    minSdkVersion rootProject.ext.minSdkVersion
    targetSdkVersion rootProject.ext.targetSdkVersion
    versionCode 63
    versionName "63.0"

    // ✅ 기본값: ABI 필터 지정하지 않음(디버그는 에뮬레이터용 x86_64까지 자동 포함)
    // ndk { abiFilters "arm64-v8a" } // ❌ 개발 중 주석

    // Kakao
    manifestPlaceholders = [ KAKAO_NATIVE_APP_KEY: "ef66c5836528d39100550fd6ca87f7dc" ]
    resValue "string", "kakao_native_app_key", "ef66c5836528d39100550fd6ca87f7dc"
    buildConfigField "String", "KAKAO_NATIVE_APP_KEY", "\"ef66c5836528d39100550fd6ca87f7dc\""

    // IAP store dimension 기본값을 play로
    missingDimensionStrategy "store", "play"
  }

  signingConfigs {
    debug {
      storeFile file('debug.keystore')
      storePassword 'android'
      keyAlias 'androiddebugkey'
      keyPassword 'android'
    }
    release {
      storeFile file(MYAPP_UPLOAD_STORE_FILE)
      storePassword MYAPP_UPLOAD_STORE_PASSWORD
      keyAlias MYAPP_UPLOAD_KEY_ALIAS
      keyPassword MYAPP_UPLOAD_KEY_PASSWORD
    }
  }

  buildTypes {
    debug {
      signingConfig signingConfigs.debug

      // ✅ 에뮬레이터/실기기 전부 케어: 디버그에만 모든 ABI 포함
      ndk { abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86', 'x86_64' }

      // Kakao 값 재주입
      manifestPlaceholders.KAKAO_NATIVE_APP_KEY = "ef66c5836528d39100550fd6ca87f7dc"
      resValue "string", "kakao_native_app_key", "ef66c5836528d39100550fd6ca87f7dc"
      buildConfigField "String","KAKAO_NATIVE_APP_KEY","\"ef66c5836528d39100550fd6ca87f7dc\""
    }
    release {
      signingConfig signingConfigs.release
      minifyEnabled enableProguardInReleaseBuilds
      proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"

      // ✅ 릴리스 슬림(스토어 용량↓): arm64만
      ndk { abiFilters 'arm64-v8a' }

      manifestPlaceholders.KAKAO_NATIVE_APP_KEY = "ef66c5836528d39100550fd6ca87f7dc"
      resValue "string", "kakao_native_app_key", "ef66c5836528d39100550fd6ca87f7dc"
      buildConfigField "String","KAKAO_NATIVE_APP_KEY","\"ef66c5836528d39100550fd6ca87f7dc\""
    }
  }

  // IAP가 요구하는 store flavor
  flavorDimensions "store"
  productFlavors {
    play { dimension "store" }
    // amazon { dimension "store" }
  }

  // amazon 변형 전체 무시(빌드 간소화)
  variantFilter { variant ->
    def names = variant.flavors*.name
    if (names.contains("amazon")) setIgnore(true)
  }

  // JDK 17 정렬
  compileOptions {
    sourceCompatibility JavaVersion.VERSION_17
    targetCompatibility JavaVersion.VERSION_17
  }
}

dependencies {
  implementation("com.facebook.react:react-android")
  if (hermesEnabled.toBoolean()) {
    implementation("com.facebook.react:hermes-android")
  } else {
    implementation jscFlavor
  }

  implementation(platform("com.google.firebase:firebase-bom:33.3.0"))
  implementation "com.kakao.sdk:v2-user:2.20.6"

  // ⚠️ IAP 사용 중이면 billing-ktx 수동 추가 금지(중복 충돌 위험)
  // implementation "com.android.billingclient:billing-ktx:6.2.1"
}

apply plugin: "com.google.gms.google-services"

// Kotlin 컴파일러 옵션(JVM 17)
tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
  kotlinOptions {
    jvmTarget = "17"
    freeCompilerArgs += ["-Xjvm-default=all-compatibility"]
  }
}
